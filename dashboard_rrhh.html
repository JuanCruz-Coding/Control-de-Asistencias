<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard RRHH - Control de Asistencia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Estilo para la tabla fija */
        .table-container {
            max-height: 600px; /* Altura máxima antes de scrollear */
            overflow-y: auto;
        }
        thead th {
            position: sticky;
            top: 0;
            background-color: #f1f5f9; /* gray-100 */
            z-index: 10;
        }
        /* Estilos del Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            pointer-events: none;
        }
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            transform: scale(0.95);
            transition: transform 0.2s ease-in-out;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- 
      VISTA DE LOGIN (Inicialmente visible)
      El dashboard de RRHH TAMBIÉN necesita login
    -->
    <div id="login-view-admin" class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Dashboard de RRHH</h1>
                <p class="text-gray-500">Acceso exclusivo para administradores.</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="email-admin" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="email-admin" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="admin@empresa.com">
                </div>
                <div>
                    <label for="password-admin" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <input type="password" id="password-admin" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="••••••••">
                </div>
                <button id="login-button-admin" class="w-full p-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                    Ingresar
                </button>
                <p id="login-error-admin" class="text-red-500 text-sm text-center hidden"></p>
            </div>
        </div>
    </div>

    <!-- 
      VISTA PRINCIPAL DEL DASHBOARD (Inicialmente oculta)
    -->
    <div id="dashboard-view" class="hidden">
        
        <!-- Barra de Navegación Superior -->
        <nav class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <span class="text-xl font-bold text-blue-600">Dashboard RRHH</span>
                    </div>
                    <div class="flex items-center">
                        <span id="admin-email" class="text-sm text-gray-600 mr-4">Cargando...</span>
                        <button id="logout-button-admin" class="text-sm text-gray-500 hover:text-blue-600 underline">Cerrar Sesión</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Contenido Principal -->
        <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            
            <!-- Pestañas de Navegación -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tab-fichadas" class="tab-button border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Últimas Fichadas
                    </button>
                    <button id="tab-empleados" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Gestión de Empleados
                    </button>
                </nav>
            </div>

            <!-- Panel 1: Fichadas (Visible por defecto) -->
            <div id="panel-fichadas" class="tab-panel">
                <h2 class="text-2xl font-semibold mb-4">Últimas Fichadas (En Tiempo Real)</h2>
                <div class="bg-white shadow-lg rounded-lg border border-gray-200 overflow-hidden">
                    <div class="table-container">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empleado</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Legajo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha y Hora</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ubicación (Link)</th>
                                </tr>
                            </thead>
                            <tbody id="fichadas-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Las filas se insertarán aquí dinámicamente -->
                                <tr id="fichadas-loading">
                                    <td colspan="5" class="px-6 py-12 text-center text-gray-500">Cargando fichadas...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Panel 2: Empleados (Oculto por defecto) -->
            <div id="panel-empleados" class="tab-panel hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Gestión de Empleados</h2>
                    <button id="add-employee-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        + Agregar Empleado
                    </button>
                </div>
                <div class="bg-white shadow-lg rounded-lg border border-gray-200 overflow-hidden">
                    <div class="table-container">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Legajo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email (Login)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">UID (Vínculo)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="empleados-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Las filas se insertarán aquí dinámicamente -->
                                <tr id="empleados-loading">
                                    <td colspan="5" class="px-6 py-12 text-center text-gray-500">Cargando empleados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>
    
    <!-- Modal para Agregar/Editar Empleado -->
    <div id="employee-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title" class="text-xl font-bold text-gray-800 mb-6">Agregar Empleado</h2>
            
            <form id="employee-form" class="space-y-4">
                <input type="hidden" id="employee-id"> <!-- Para saber si estamos editando -->
                
                <div>
                    <label for="form-nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo</label>
                    <input type="text" id="form-nombre" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Perez, Juan" required>
                </div>
                
                <div>
                    <label for="form-legajo" class="block text-sm font-medium text-gray-700 mb-1">Legajo</label>
                    <input type="number" id="form-legajo" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="102" required>
                </div>
                
                <div>
                    <label for="form-email" class="block text-sm font-medium text-gray-700 mb-1">Email (para Login)</label>
                    <input type="email" id="form-email" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="juan.perez@empresa.com" required>
                </div>
                
                <div>
                    <label for="form-uid" class="block text-sm font-medium text-gray-700 mb-1">UID de Authentication (Vínculo)</label>
                    <input type="text" id="form-uid" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Pegar el UID de Firebase Auth aquí">
                    <p class="text-xs text-gray-500 mt-1">Este campo es el **ID de Documento** en Firestore. Debe coincidir con el UID de Authentication.</p>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" id="modal-save-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Guardar</button>
                </div>
                
                <p id="modal-error" class="text-red-500 text-sm text-center hidden"></p>
            </form>
        </div>
    </div>


    <!-- 
    ====================================================================
    SCRIPT (Toda la lógica del Dashboard)
    ====================================================================
    -->
    <script type="module">
        //----------------------------------------------------------------------
        // SECCIÓN 1: IMPORTACIONES DE FIREBASE (Versión 12.5.0)
        //----------------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            onSnapshot, // ¡Clave! Escucha cambios en tiempo real
            query,
            // addDoc, (Usaremos setDoc para tener control del ID)
            setDoc,     // Para crear/sobrescribir un documento con un ID específico
            doc,        // Para referenciar un documento
            deleteDoc,  // Para borrar un documento
            getDocs,    // Para cargar todos los docs una vez
            orderBy     // Para ordenar los resultados
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        
        //----------------------------------------------------------------------
        // SECCIÓN 2: TU CONFIGURACIÓN DE FIREBASE
        //----------------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyCFuc1zvAHZgNc4zttimrxdPQJz4Gpt-sw",
            authDomain: "controldeasistencia-14364.firebaseapp.com",
            projectId: "controldeasistencia-14364",
            storageBucket: "controldeasistencia-14364.firebasestorage.app",
            messagingSenderId: "246986968365",
            appId: "1:246986968365:web:8b44be26abd0a2f14f17a4",
            measurementId: "G-P7ZXTPKLRE"
        };
        
        //----------------------------------------------------------------------
        // SECCIÓN 3: VARIABLES GLOBALES Y ELEMENTOS DEL DOM
        //----------------------------------------------------------------------
        let db, auth;
        let unsubscribeFichadas = null; // Para detener el listener de fichadas
        let unsubscribeEmpleados = null; // Para detener el listener de empleados

        // Vistas
        const loginView = document.getElementById('login-view-admin');
        const dashboardView = document.getElementById('dashboard-view');
        
        // Login Admin
        const emailAdminInput = document.getElementById('email-admin');
        const passwordAdminInput = document.getElementById('password-admin');
        const loginButtonAdmin = document.getElementById('login-button-admin');
        const loginErrorAdmin = document.getElementById('login-error-admin');
        const adminEmail = document.getElementById('admin-email');
        const logoutButtonAdmin = document.getElementById('logout-button-admin');
        
        // Pestañas
        const tabFichadas = document.getElementById('tab-fichadas');
        const tabEmpleados = document.getElementById('tab-empleados');
        const panelFichadas = document.getElementById('panel-fichadas');
        const panelEmpleados = document.getElementById('panel-empleados');
        
        // Tablas
        const fichadasTableBody = document.getElementById('fichadas-table-body');
        const fichadasLoading = document.getElementById('fichadas-loading');
        const empleadosTableBody = document.getElementById('empleados-table-body');
        const empleadosLoading = document.getElementById('empleados-loading');
        
        // Modal Empleados
        const employeeModal = document.getElementById('employee-modal');
        const employeeForm = document.getElementById('employee-form');
        const modalTitle = document.getElementById('modal-title');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalError = document.getElementById('modal-error');
        const addEmployeeBtn = document.getElementById('add-employee-btn');
        
        // Campos del Formulario
        const formNombre = document.getElementById('form-nombre');
        const formLegajo = document.getElementById('form-legajo');
        const formEmail = document.getElementById('form-email');
        const formUid = document.getElementById('form-uid');
        const employeeId = document.getElementById('employee-id'); // El ID (UID) del documento
        
        
        //----------------------------------------------------------------------
        // SECCIÓN 4: INICIALIZACIÓN Y LOGIN DE ADMIN
        //----------------------------------------------------------------------
        
        function initAdminApp() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                setupAdminAuthObserver();
                
                // Eventos de Login
                loginButtonAdmin.addEventListener('click', handleAdminLogin);
                logoutButtonAdmin.addEventListener('click', handleAdminLogout);
                
                // Eventos de Pestañas
                tabFichadas.addEventListener('click', () => switchTab('fichadas'));
                tabEmpleados.addEventListener('click', () => switchTab('empleados'));
                
                // Eventos del Modal
                addEmployeeBtn.addEventListener('click', openEmployeeModal);
                modalCancelBtn.addEventListener('click', closeEmployeeModal);
                employeeForm.addEventListener('submit', handleSaveEmployee);
                
            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                loginErrorAdmin.textContent = "Error crítico de conexión.";
                loginErrorAdmin.classList.remove('hidden');
            }
        }

        function setupAdminAuthObserver() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Solo permitir el login si el email es el tuyo (o de otro admin)
                    // Esta es una capa de seguridad simple para que un empleado no
                    // pueda loguearse al dashboard de admin.
                    // Podrías tener una lista de emails de admins.
                    if (user.email === 'juancruz.montagni@novogar.com.ar') {
                        console.log("Admin autenticado:", user.email);
                        adminEmail.textContent = user.email;
                        
                        loginView.classList.add('hidden');
                        dashboardView.classList.remove('hidden');
                        
                        // Iniciar la carga de datos
                        loadFichadas();
                        loadEmpleados();
                    } else {
                        // Si un empleado intenta loguearse, lo rechazamos.
                        console.warn("Intento de login de NO-ADMIN:", user.email);
                        handleAdminLogout(); // Lo deslogueamos
                        loginErrorAdmin.textContent = "No tenés permisos de administrador.";
                        loginErrorAdmin.classList.remove('hidden');
                    }
                    
                } else {
                    console.log("Admin no autenticado.");
                    loginView.classList.remove('hidden');
                    dashboardView.classList.add('hidden');
                    
                    // Detener la carga de datos si estaba activa
                    if (unsubscribeFichadas) unsubscribeFichadas();
                    if (unsubscribeEmpleados) unsubscribeEmpleados();
                }
            });
        }
        
        async function handleAdminLogin() {
            const email = emailAdminInput.value.trim();
            const password = passwordAdminInput.value;
            
            if (!email || !password) {
                loginErrorAdmin.textContent = "Completá el email y la contraseña.";
                loginErrorAdmin.classList.remove('hidden');
                return;
            }
            
            loginButtonAdmin.disabled = true;
            loginButtonAdmin.textContent = "Ingresando...";
            loginErrorAdmin.classList.add('hidden');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged se encarga del resto
            } catch (error) {
                console.error("Error de login admin:", error.code);
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    loginErrorAdmin.textContent = "Email o contraseña incorrectos.";
                } else {
                    loginErrorAdmin.textContent = "Error al ingresar.";
                }
                loginErrorAdmin.classList.remove('hidden');
            } finally {
                loginButtonAdmin.disabled = false;
                loginButtonAdmin.textContent = "Ingresar";
            }
        }
        
        function handleAdminLogout() {
            signOut(auth);
        }
        
        //----------------------------------------------------------------------
        // SECCIÓN 5: LÓGICA DE PESTAÑAS
        //----------------------------------------------------------------------
        
        function switchTab(tab) {
            if (tab === 'fichadas') {
                panelFichadas.classList.remove('hidden');
                panelEmpleados.classList.add('hidden');
                tabFichadas.className = "tab-button border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm";
                tabEmpleados.className = "tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm";
            } else if (tab === 'empleados') {
                panelFichadas.classList.add('hidden');
                panelEmpleados.classList.remove('hidden');
                tabEmpleados.className = "tab-button border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm";
                tabFichadas.className = "tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm";
            }
        }

        //----------------------------------------------------------------------
        // SECCIÓN 6: LÓGICA DE FICHADAS
        //----------------------------------------------------------------------
        
        function loadFichadas() {
            console.log("Cargando listener de Fichadas...");
            // Ordenamos por 'timestamp' en orden descendente (las más nuevas primero)
            const q = query(collection(db, "fichadas"), orderBy("timestamp", "desc"));
            
            unsubscribeFichadas = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    fichadasLoading.textContent = "No se encontraron fichadas.";
                    return;
                }
                
                fichadasLoading.classList.add('hidden');
                fichadasTableBody.innerHTML = ''; // Limpiar tabla
                
                snapshot.forEach(doc => {
                    const fichada = doc.data();
                    const tr = document.createElement('tr');
                    
                    // Formatear Fecha
                    let fecha = "Fecha inválida";
                    if (fichada.timestamp) {
                        // Convertir el Timestamp de Firebase a Date
                        fecha = fichada.timestamp.toDate().toLocaleString('es-AR', {
                            day: '2-digit', month: '2-digit', year: 'numeric',
                            hour: '2-digit', minute: '2-digit'
                        });
                    }

                    // Formatear Tipo
                    const tipo = fichada.tipo === 'entrada' ? 
                        '<span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Entrada</span>' : 
                        '<span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Salida</span>';

                    // Formatear Ubicación
                    let ubicacionLink = "No disponible";
                    if (fichada.geolocalizacion) {
                        // El GeoPoint se lee como .latitude y .longitude
                        const lat = fichada.geolocalizacion.latitude;
                        const lon = fichada.geolocalizacion.longitude;
                        ubicacionLink = `<a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" class="text-blue-600 hover:underline">Ver en Mapa</a>`;
                    }
                    
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${fichada.nombre || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${fichada.legajo || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${fecha}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${tipo}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${ubicacionLink}</td>
                    `;
                    fichadasTableBody.appendChild(tr);
                });
                
            }, (error) => {
                console.error("Error al cargar fichadas: ", error);
                // ¡ERROR COMÚN! Si esto falla, puede ser por el índice de Firestore.
                if (error.code === 'failed-precondition') {
                    fichadasLoading.innerHTML = `Error: Necesitás crear un índice en Firestore. <br> Hacé clic en el link de este error en la consola y crealo.`;
                    console.error("¡¡¡ACCIÓN REQUERIDA!!!", error.message);
                } else {
                    fichadasLoading.textContent = "Error al cargar datos.";
                }
            });
        }
        
        //----------------------------------------------------------------------
        // SECCIÓN 7: LÓGICA DE GESTIÓN DE EMPLEADOS (CRUD)
        //----------------------------------------------------------------------
        
        function loadEmpleados() {
            console.log("Cargando listener de Empleados...");
            // Ordenamos por 'legajo'
            const q = query(collection(db, "empleados"), orderBy("legajo"));
            
            unsubscribeEmpleados = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    empleadosLoading.textContent = "No se encontraron empleados. Agregá el primero.";
                    return;
                }
                
                empleadosLoading.classList.add('hidden');
                empleadosTableBody.innerHTML = ''; // Limpiar tabla
                
                snapshot.forEach(doc => {
                    const empleado = doc.data();
                    const uid = doc.id; // El ID del documento (que debe ser el UID de Auth)
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${empleado.nombre || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${empleado.legajo || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${empleado.email || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono text-xs">${uid}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="edit-btn text-blue-600 hover:text-blue-900" data-id="${uid}">Editar</button>
                            <button class="delete-btn text-red-600 hover:text-red-900 ml-4" data-id="${uid}" data-nombre="${empleado.nombre || 'este empleado'}">Borrar</button>
                        </td>
                    `;
                    
                    // Agregar eventos a los botones de Editar y Borrar
                    tr.querySelector('.delete-btn').addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        const nombre = e.target.dataset.nombre;
                        handleDeleteEmployee(id, nombre);
                    });
                    
                    tr.querySelector('.edit-btn').addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        // Pasamos el doc.id y los datos al modal
                        openEmployeeModal(id, empleado);
                    });
                    
                    empleadosTableBody.appendChild(tr);
                });
                
            }, (error) => {
                console.error("Error al cargar empleados: ", error);
                if (error.code === 'failed-precondition') {
                    empleadosLoading.innerHTML = `Error: Necesitás crear un índice en Firestore. <br> Hacé clic en el link de este error en la consola y crealo.`;
                    console.error("¡¡¡ACCIÓN REQUERIDA!!!", error.message);
                } else {
                    empleadosLoading.textContent = "Error al cargar datos.";
                }
            });
        }
        
        function openEmployeeModal(uid = null, data = {}) {
            employeeForm.reset();
            modalError.classList.add('hidden');
            
            if (uid && data) {
                // Modo Editar
                modalTitle.textContent = "Editar Empleado";
                employeeId.value = uid; // Guardamos el ID del doc
                formNombre.value = data.nombre || '';
                formLegajo.value = data.legajo || '';
                formEmail.value = data.email || '';
                formUid.value = uid;
                formUid.disabled = true; // No se puede editar el UID (ID del doc)
            } else {
                // Modo Agregar
                modalTitle.textContent = "Agregar Empleado";
                employeeId.value = ''; // Limpiamos el ID
                formUid.disabled = false; // El UID debe ser ingresado manualmente
            }
            
            employeeModal.classList.add('visible');
        }
        
        function closeEmployeeModal() {
            employeeModal.classList.remove('visible');
        }
        
        async function handleSaveEmployee(e) {
            e.preventDefault(); // Evitar que la página se recargue
            
            const nombre = formNombre.value.trim();
            const legajo = parseInt(formLegajo.value);
            const email = formEmail.value.trim();
            const uid = formUid.value.trim(); // Este es el ID del documento
            
            if (!nombre || !legajo || !email || !uid) {
                modalError.textContent = "Todos los campos (incluido UID) son obligatorios.";
                modalError.classList.remove('hidden');
                return;
            }
            
            modalSaveBtn.disabled = true;
            modalSaveBtn.textContent = "Guardando...";
            
            try {
                // Usamos el UID como ID del documento en la colección "empleados"
                const docRef = doc(db, "empleados", uid);
                
                // setDoc CREA o SOBREESCRIBE
                await setDoc(docRef, {
                    nombre: nombre,
                    legajo: legajo,
                    email: email
                    // No guardamos el UID adentro, ya es el ID del documento
                });
                
                console.log("Empleado guardado con ID: ", uid);
                closeEmployeeModal();
                
            } catch (error) {
                console.error("Error al guardar empleado: ", error);
                modalError.textContent = "Error al guardar. Verificá los datos.";
                modalError.classList.remove('hidden');
            } finally {
                modalSaveBtn.disabled = false;
                modalSaveBtn.textContent = "Guardar";
            }
        }
        
        async function handleDeleteEmployee(uid, nombre) {
            // ¡¡¡NUNCA USAR confirm()!!!
            // En una app real, acá mostraríamos un modal de confirmación.
            // Por simplicidad, vamos a asumir que sí, pero no podemos pausar
            // la ejecución del script. Lo borramos directamente.
            console.log(`Pedido de borrado para ${nombre} (UID: ${uid}).`);
            
            // IMPORTANTE: Esto borra el documento de Firestore,
            // pero NO borra el usuario de Authentication.
            // Eso (por ahora) sigue siendo un paso manual.
            
            try {
                const docRef = doc(db, "empleados", uid);
                await deleteDoc(docRef);
                console.log("Empleado borrado (solo de Firestore):", uid);
                
            } catch (error) {
                console.error("Error al borrar empleado:", error);
                // No podemos usar alert, mostramos en consola
                console.error("Error al borrar el empleado de Firestore.");
            }
        }

        //----------------------------------------------------------------------
        // SECCIÓN 8: INICIO DE LA APLICACIÓN
        //----------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', initAdminApp);
    </script>
</body>
</html>

