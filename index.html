<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Asistencia</title>
    <!-- 
      Usamos TailwindCSS para los estilos.
      "Inter" es una fuente limpia y moderna.
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Seteamos la fuente base */
        body { 
            font-family: 'Inter', sans-serif; 
            /* Evita que la página "salte" al aparecer la barra de scroll */
            overflow-y: scroll;
        }
        
        /* Estilos para el "Modal" de mensajes.
          Usamos 'fixed' para que flote sobre todo.
        */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5); /* Fondo oscuro semitransparente */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            pointer-events: none; /* No se puede clickear cuando está oculto */
        }
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto; /* Se puede clickear cuando está visible */
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            transform: scale(0.95); /* Efecto "zoom" de entrada */
            transition: transform 0.2s ease-in-out;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- 
      Este es el contenedor principal.
      Usamos un 'id' para poder ocultarlo/mostrarlo.
    -->
    <div id="app-container" class="max-w-md mx-auto min-h-screen bg-white shadow-lg">

        <!-- 
          VISTA 1: PANTALLA DE LOGIN
          Esta vista se muestra si el usuario NO está logueado.
        -->
        <div id="login-view" class="p-8 pt-16">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">Control de Asistencia</h1>
            <p class="text-center text-gray-500 mb-8">Por favor, iniciá sesión para fichar.</p>

            <div class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="tu.email@empresa.com">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <input type="password" id="password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="••••••••">
                </div>
                
                <button id="login-button" class="w-full p-4 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                    Ingresar
                </button>
                
                <p id="login-error" class="text-red-500 text-sm text-center hidden"></p>
            </div>
        </div>

        <!-- 
          VISTA 2: PANTALLA DE FICHADA
          Esta vista se muestra DESPUÉS de un login exitoso.
        -->
        <div id="fichada-view" class="p-6 hidden">
            <!-- Header con datos del empleado -->
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800" id="empleado-nombre">Cargando...</h2>
                    <p class="text-gray-500" id="empleado-legajo">Legajo: ...</p>
                </div>
                <button id="logout-button" class="text-sm text-gray-500 hover:text-blue-600 underline">Salir</button>
            </div>

            <!-- Card principal de fichada -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h3 class="text-lg font-semibold text-center text-gray-700 mb-6">Mi Fichada</h3>
                
                <div class="space-y-4">
                    <button id="fichar-entrada-btn" class="w-full p-5 bg-green-500 text-white rounded-lg text-lg font-bold hover:bg-green-600 transition-colors disabled:opacity-50">
                        FICHAR ENTRADA
                    </button>
                    <button id="fichar-salida-btn" class="w-full p-5 bg-red-500 text-white rounded-lg text-lg font-bold hover:bg-red-600 transition-colors disabled:opacity-50">
                        FICHAR SALIDA
                    </button>
                </div>
            </div>
            
            <!-- Card de Verificaciones -->
            <div class="bg-white p-6 mt-6 rounded-xl shadow-lg border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Verificaciones</h3>
                <ul id="verificaciones-lista" class="space-y-3">
                    <!-- Los items de esta lista se generan con JavaScript -->
                    <li class="flex items-center text-gray-500">
                        <span class="mr-3">...</span>
                        <span>Esperando inicio...</span>
                    </li>
                </ul>
            </div>
        </div>

        <!-- 
          VISTA 3: PANTALLA DE CARGA GLOBAL
          Se usa mientras se chequea si el usuario ya está logueado.
        -->
        <div id="loading-view" class="p-8 pt-32 text-center">
            <h2 class="text-xl font-semibold text-gray-600">Verificando...</h2>
            <p class="text-gray-500">Cargando aplicación.</p>
        </div>

    </div> <!-- Fin de #app-container -->


    <!-- 
      MODAL DE MENSAJES (Error, Éxito, Info)
      Inicialmente está oculto (opacity-0, pointer-events-none)
    -->
    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <div id="modal-icono" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <!-- Icono de Error (se puede cambiar por JS) -->
                <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 id="modal-titulo" class="text-lg font-bold text-center text-gray-900 mb-2">Error al Fichar</h3>
            <p id="modal-mensaje" class="text-sm text-gray-600 text-center mb-6">Hubo un problema.</p>
            <button id="modal-cerrar-btn" class="w-full p-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                Entendido
            </button>
        </div>
    </div>


    <!-- 
    ====================================================================
    SCRIPT (Toda la lógica de la app)
    ====================================================================
    -->
    <script type="module">
        //----------------------------------------------------------------------
        // SECCIÓN 1: IMPORTACIONES DE FIREBASE (Versión 12.5.0)
        //----------------------------------------------------------------------
        
        // Funciones principales
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        
        // Funciones de Autenticación (Login)
        import { 
            getAuth, 
            onAuthStateChanged, // El "vigilante" que mira si alguien inició sesión
            signInWithEmailAndPassword, // Para el login
            signOut // Para cerrar sesión
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        
        // Funciones de Base de Datos (Firestore)
        import { 
            getFirestore, 
            doc,          // Referencia a un documento específico
            getDoc,       // Función para LEER un documento
            setDoc,       // Función para CREAR/SOBREESCRIBIR un documento
            addDoc,       // Función para AGREGAR un documento (con ID automático)
            collection,   // Referencia a una colección
            serverTimestamp, // ¡¡¡CLAVE!!! Para la hora del servidor (Capa 1)
            GeoPoint      // Para guardar coordenadas GPS
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        
        //----------------------------------------------------------------------
        // SECCIÓN 2: TU CONFIGURACIÓN DE FIREBASE
        // (La que me pasaste)
        //----------------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyCFuc1zvAHZgNc4zttimrxdPQJz4Gpt-sw",
            authDomain: "controldeasistencia-14364.firebaseapp.com",
            projectId: "controldeasistencia-14364",
            storageBucket: "controldeasistencia-14364.firebasestorage.app",
            messagingSenderId: "246986968365",
            appId: "1:246986968365:web:8b44be26abd0a2f14f17a4",
            measurementId: "G-P7ZXTPKLRE"
        };
        
        //----------------------------------------------------------------------
        // SECCIÓN 3: CONFIGURACIÓN DE LA APP (Tolerancia, Coordenadas)
        //----------------------------------------------------------------------
        
        // ¡¡¡IMPORTANTE!!! Cambiá estas coordenadas por las de tu oficina
        const COORDENADAS_OFICINA = {
            lat: -33.0515758, // Latitud de la oficina
            lon: -60.6035893  // Longitud de la oficina
        };
        
        // Distancia máxima permitida para fichar (en metros)
        const TOLERANCIA_METROS = 100;
        
        
        //----------------------------------------------------------------------
        // SECCIÓN 4: VARIABLES GLOBALES Y ELEMENTOS DEL DOM
        //----------------------------------------------------------------------
        
        // Servicios de Firebase
        let db, auth;
        
        // Datos del empleado logueado
        let empleadoActual = null; // { uid, nombre, legajo, email }
        
        // Elementos del DOM (Vistas)
        const loadingView = document.getElementById('loading-view');
        const loginView = document.getElementById('login-view');
        const fichadaView = document.getElementById('fichada-view');
        
        // Elementos del DOM (Login)
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        
        // Elementos del DOM (Fichada)
        const empleadoNombre = document.getElementById('empleado-nombre');
        const empleadoLegajo = document.getElementById('empleado-legajo');
        const logoutButton = document.getElementById('logout-button');
        const ficharEntradaBtn = document.getElementById('fichar-entrada-btn');
        const ficharSalidaBtn = document.getElementById('fichar-salida-btn');
        const verificacionesLista = document.getElementById('verificaciones-lista');
        
        // Elementos del DOM (Modal)
        const modal = document.getElementById('modal');
        const modalTitulo = document.getElementById('modal-titulo');
        const modalMensaje = document.getElementById('modal-mensaje');
        const modalIcono = document.getElementById('modal-icono');
        const modalCerrarBtn = document.getElementById('modal-cerrar-btn');
        
        
        //----------------------------------------------------------------------
        // SECCIÓN 5: INICIALIZACIÓN Y MANEJO DE AUTENTICACIÓN (LOGIN)
        //----------------------------------------------------------------------

        /**
         * Inicializa Firebase y ata los eventos de login
         */
        function initApp() {
            try {
                // 1. Inicializar la app de Firebase
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app); // Se conecta a la BD (default)
                
                // 2. Atar los eventos de los botones
                loginButton.addEventListener('click', handleLogin);
                logoutButton.addEventListener('click', handleLogout);
                ficharEntradaBtn.addEventListener('click', () => handleFichar('entrada'));
                ficharSalidaBtn.addEventListener('click', () => handleFichar('salida'));
                modalCerrarBtn.addEventListener('click', cerrarModal);
                
                // 3. Iniciar el "vigilante" de autenticación
                setupAuthObserver();
                
            } catch (error) {
                console.error("Error crítico al inicializar Firebase:", error);
                mostrarVista('login');
                loginError.textContent = "Error de conexión. Revisá la consola.";
                loginError.classList.remove('hidden');
            }
        }

        /**
         * El "vigilante": escucha cambios en el estado de login (inicio, cierre de sesión)
         * Esta es la función más importante de la app.
         */
        function setupAuthObserver() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // --- CASO 1: Usuario SÍ está logueado ---
                    console.log("Usuario detectado:", user.uid);
                    mostrarVista('loading'); // Mostrar "Cargando..."
                    
                    try {
                        // Buscar los datos del empleado en Firestore
                        const datosEmpleado = await cargarDatosEmpleado(user.uid);
                        if (datosEmpleado) {
                            // Si encontramos los datos...
                            empleadoActual = {
                                uid: user.uid,
                                email: user.email,
                                ...datosEmpleado // ...copiamos nombre, legajo, etc.
                            };
                            
                            // Actualizamos la UI
                            empleadoNombre.textContent = empleadoActual.nombre;
                            empleadoLegajo.textContent = `Legajo: ${empleadoActual.legajo}`;
                            
                            // ¡Mostramos la app de fichar!
                            mostrarVista('fichada');
                        } else {
                            // Error: Usuario logueado pero sin datos en Firestore
                            console.error("Error: Usuario autenticado pero sin datos en 'empleados'.");
                            handleLogout(); // Forzar cierre de sesión
                            mostrarModal("Error de Datos", "Tu usuario está activo pero no se encontraron tus datos de empleado (legajo, nombre). Contactá a RRHH.", "error");
                        }
                    } catch (error) {
                        // Error al buscar datos
                        console.error("Error al cargar datos de empleado:", error);
                        handleLogout();
                        mostrarModal("Error de Base de Datos", "No se pudieron cargar tus datos. Intentá de nuevo.", "error");
                    }
                    
                } else {
                    // --- CASO 2: Usuario NO está logueado ---
                    console.log("No hay usuario logueado.");
                    empleadoActual = null;
                    mostrarVista('login'); // Mostrar la pantalla de login
                }
            });
        }
        
        /**
         * Función que se ejecuta al apretar "Ingresar"
         */
        async function handleLogin() {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            
            if (!email || !password) {
                loginError.textContent = "Completá el email y la contraseña.";
                loginError.classList.remove('hidden');
                return;
            }
            
            // Deshabilitar botón para evitar doble click
            loginButton.disabled = true;
            loginButton.textContent = "Ingresando...";
            loginError.classList.add('hidden');

            try {
                // Intentamos iniciar sesión con Firebase Auth
                await signInWithEmailAndPassword(auth, email, password);
                // Si tiene éxito, onAuthStateChanged() (el "vigilante")
                // se disparará y manejará el cambio de vista.
                
            } catch (error) {
                console.error("Error de login:", error.code);
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    loginError.textContent = "Email o contraseña incorrectos.";
                } else {
                    loginError.textContent = "Error al intentar ingresar.";
                }
                loginError.classList.remove('hidden');
            } finally {
                // Volver a habilitar el botón
                loginButton.disabled = false;
                loginButton.textContent = "Ingresar";
            }
        }
        
        /**
         * Cierra la sesión del usuario
         */
        function handleLogout() {
            signOut(auth);
        }
        
        /**
         * Busca en Firestore los datos del empleado usando su UID
         * (Como lo explicamos en la guía 'guia_usuarios.md')
         */
        async function cargarDatosEmpleado(uid) {
            // 1. Apuntar al documento correcto: coleccion 'empleados', documento 'uid'
            const docRef = doc(db, "empleados", uid);
            
            // 2. Pedir el documento
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                // 3. Si existe, devolver los datos
                return docSnap.data(); // { nombre: "...", legajo: "..." }
            } else {
                // 4. Si no existe, devolver null
                return null;
            }
        }
        
        //----------------------------------------------------------------------
        // SECCIÓN 6: LÓGICA DE FICHADA (GPS y Guardado)
        //----------------------------------------------------------------------
        
        /**
         * Función principal al apretar "FICHAR ENTRADA/SALIDA"
         */
        async function handleFichar(tipo) {
            // Deshabilitar botones para evitar doble fichada
            ficharEntradaBtn.disabled = true;
            ficharSalidaBtn.disabled = true;
            verificacionesLista.innerHTML = ''; // Limpiar lista
            
            try {
                // --- PASO 1: Obtener Ubicación GPS ---
                actualizarVerificacion("Buscando ubicación GPS...", "loading");
                const coords = await obtenerUbicacion();
                const miUbicacion = { lat: coords.latitude, lon: coords.longitude };
                actualizarVerificacion("Ubicación GPS obtenida.", "success");
                
                // --- PASO 2: Calcular Distancia ---
                actualizarVerificacion("Calculando distancia a la oficina...", "loading");
                const distancia = calcularDistancia(miUbicacion, COORDENADAS_OFICINA);
                actualizarVerificacion(`Estás a ${distancia.toFixed(0)}m de la oficina.`, "success");

                // --- PASO 3: Validar Distancia ---
                if (distancia > TOLERANCIA_METROS) {
                    // ¡¡¡ERROR: MUY LEJOS!!!
                    throw new Error(`Estás demasiado lejos de la oficina (a ${distancia.toFixed(0)}m).`);
                }
                actualizarVerificacion(`Ubicación válida (dentro de los ${TOLERANCIA_METROS}m).`, "success");
                
                // --- PASO 4: Preparar los datos para guardar ---
                const fichadaData = {
                    legajo: empleadoActual.legajo,
                    nombre: empleadoActual.nombre,
                    uid: empleadoActual.uid,
                    tipo: tipo,
                    // ¡¡¡CAPA 1 DE SEGURIDAD!!!
                    // Usamos la hora del servidor, no la del celular.
                    timestamp: serverTimestamp(),
                    
                    // Guardamos la geolocalización como un tipo de dato especial
                    geolocalizacion: new GeoPoint(miUbicacion.lat, miUbicacion.lon),
                    distancia_metros: distancia
                };

                // --- PASO 5: Guardar en Firebase ---
                actualizarVerificacion("Enviando fichada al servidor...", "loading");
                // Usamos addDoc para que genere un ID automático para la fichada
                const docRef = await addDoc(collection(db, "fichadas"), fichadaData);
                console.log("Fichada guardada con ID: ", docRef.id);
                actualizarVerificacion("¡Fichada registrada con éxito!", "success");
                
                // Mostrar modal de éxito
                mostrarModal(
                    "Fichada Exitosa", 
                    `Se registró tu ${tipo} a las ${new Date().toLocaleTimeString('es-AR')}.`, 
                    "success"
                );

            } catch (error) {
                // Manejo de CUALQUIER error (GPS, Distancia, Firebase)
                console.error("Error al fichar:", error);
                actualizarVerificacion(error.message, "error");
                mostrarModal("Error al Fichar", error.message, "error");
                
            } finally {
                // Volver a habilitar los botones
                ficharEntradaBtn.disabled = false;
                ficharSalidaBtn.disabled = false;
            }
        }
        
        /**
         * Promesa que resuelve la ubicación GPS
         */
        function obtenerUbicacion() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("Tu navegador no soporta Geolocalización."));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (posicion) => {
                        // ¡Éxito!
                        resolve(posicion.coords);
                    }, 
                    (error) => {
                        // Error
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                reject(new Error("No diste permiso para acceder a la ubicación."));
                                break;
                            case error.POSITION_UNAVAILABLE:
                                reject(new Error("No se pudo determinar tu ubicación."));
                                break;
                            case error.TIMEOUT:
                                reject(new Error("Se agotó el tiempo de espera para obtener la ubicación."));
                                break;
                            default:
                                reject(new Error("Ocurrió un error desconocido de GPS."));
                        }
                    },
                    {
                        // Opciones de alta precisión
                        enableHighAccuracy: true,
                        timeout: 10000, // 10 segundos de tiempo límite
                        maximumAge: 0 // No usar caché, pedir posición fresca
                    }
                );
            });
        }
        
        /**
         * Calcula la distancia entre dos puntos (fórmula de Haversine)
         * Devuelve el resultado en metros.
         */
        function calcularDistancia(coords1, coords2) {
            const R = 6371e3; // Radio de la Tierra en metros
            const dLat = (coords2.lat - coords1.lat) * (Math.PI / 180);
            const dLon = (coords2.lon - coords1.lon) * (Math.PI / 180);
            const lat1Rad = coords1.lat * (Math.PI / 180);
            const lat2Rad = coords2.lat * (Math.PI / 180);

            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1Rad) * Math.cos(lat2Rad) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            
            return R * c; // Distancia en metros
        }
        
        
        //----------------------------------------------------------------------
        // SECCIÓN 7: FUNCIONES DE UI (Helpers)
        //----------------------------------------------------------------------
        
        /**
         * Controla qué vista principal se muestra
         */
        function mostrarVista(vista) {
            loadingView.classList.add('hidden');
            loginView.classList.add('hidden');
            fichadaView.classList.add('hidden');
            
            if (vista === 'loading') {
                loadingView.classList.remove('hidden');
            } else if (vista === 'login') {
                loginView.classList.remove('hidden');
            } else if (vista === 'fichada') {
                fichadaView.classList.remove('hidden');
            }
        }
        
        /**
         * Muestra un mensaje en la lista de verificaciones
         */
        function actualizarVerificacion(mensaje, tipo) {
            let icono = '...';
            let color = 'text-gray-500';
            
            if (tipo === 'loading') {
                icono = '⏳'; // Reloj de arena
                color = 'text-gray-700';
            } else if (tipo === 'success') {
                icono = '✅'; // Tilde verde
                color = 'text-green-600';
            } else if (tipo === 'error') {
                icono = '❌'; // Cruz roja
                color = 'text-red-600';
            }
            
            const li = document.createElement('li');
            li.className = `flex items-center font-medium ${color}`;
            li.innerHTML = `<span class="mr-3">${icono}</span><span>${mensaje}</span>`;
            
            verificacionesLista.appendChild(li);
        }

        /**
         * Muestra el modal flotante
         */
        function mostrarModal(titulo, mensaje, tipo = "error") {
            modalTitulo.textContent = titulo;
            modalMensaje.textContent = mensaje;
            
            // Cambiar icono y color según el tipo
            if (tipo === 'success') {
                modalIcono.className = "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4";
                modalIcono.innerHTML = `<svg class="h-6 w-6 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>`;
            } else { // 'error'
                modalIcono.className = "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4";
                modalIcono.innerHTML = `<svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>`;
            }
            
            modal.classList.add('visible');
        }

        /**
         * Oculta el modal flotante
         */
        function cerrarModal() {
            modal.classList.remove('visible');
        }
        
        //----------------------------------------------------------------------
        // SECCIÓN 8: INICIO DE LA APLICACIÓN
        //----------------------------------------------------------------------
        
        // Esperar a que el HTML esté cargado para iniciar la app
        document.addEventListener('DOMContentLoaded', initApp);
        
    </script>
</body>
</html>

